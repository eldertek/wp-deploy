{% extends "base.html" %}

{% block title %}Ajouter un domaine{% endblock %}

{% block content %}
<div class="card shadow-lg p-4 mb-4 w-100">
    <h1 class="card-title">Ajouter un domaine</h1>
    <form id="domainForm">
        <div class="form-group">
            <label for="domain">Nom de domaine</label>
            <input type="text" class="form-control" id="domain" name="domain" required>
        </div>
        <button type="submit" class="btn btn-primary" id="submitButton">Ajouter</button>
    </form>
</div>
<div id="messages"></div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">Confirmation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="confirmationMessage">
                <!-- Message will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirmButton">Continuer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    var socket = io.connect('https://' + document.domain + ':' + location.port);
    socket.on('message', function(msg) {
        var messages = document.getElementById('messages');
        var message = document.createElement('div');
        message.className = 'alert alert-info mt-4';
        message.innerText = msg;
        messages.insertBefore(message, messages.firstChild);
    });

    socket.on('error', function(msg) {
        var messages = document.getElementById('messages');
        var message = document.createElement('div');
        message.className = 'alert alert-danger mt-4';
        message.innerText = msg;
        messages.insertBefore(message, messages.firstChild);
    });

    socket.on('confirm', function(data) {
        $('#confirmationModal').modal('show');
        $('#confirmationMessage').text(data.message);
        $('#confirmButton').data('action', data.action);
    });

    $('#confirmButton').on('click', function() {
        var action = $(this).data('action');
        var domain = $('#domain').val();
        $.ajax({
            type: 'POST',
            url: '{{ url_for("confirm_action") }}',
            data: JSON.stringify({action: action, domain: domain}),
            contentType: 'application/json',
            success: function() {
                $('#confirmationModal').modal('hide');
            }
        });
    });

    document.getElementById('domainForm').addEventListener('submit', function(event) {
        event.preventDefault();
        var domain = $('#domain').val();
        var submitButton = document.getElementById('submitButton');
        submitButton.disabled = true;
        checkDomainOwnership(domain);
    });

    function checkDomainOwnership(domain) {
        $.post('{{ url_for("check_domain_ownership") }}', {domain: domain}, function(data) {
            if (data.status === 'owned') {
                // Domain is already owned, configure dns
                configureDNS(domain);
            } else if (data.status === 'not_owned') {
                // Domain is not owned, check availability
                checkDomainAvailability(domain);
            }
        });
    }

    function checkDomainAvailability(domain) {
        $.post('{{ url_for("check_domain_availability") }}', {domain: domain}, function(data) {
            if (data.status === 'available') {
                // Domain is available, purchase it
                purchaseDomain(domain);
            } else if (data.status === 'not_available') {
                // Domain is not available, show error message
                var messages = document.getElementById('messages');
                var message = document.createElement('div');
                message.className = 'alert alert-danger mt-4';
                message.innerText = 'Le domaine n\'est pas disponible.';
                messages.insertBefore(message, messages.firstChild);
                submitButton.disabled = false;
            }
        });
    }

    function purchaseDomain(domain) {
        $.post('{{ url_for("purchase_domain_route") }}', {domain: domain}, function(data) {
            if (data.status === 'purchased') {
                // Domain purchased, configure DNS
                configureDNS(domain);
            } else if (data.status === 'error') {
                // Error purchasing domain, show error message
                var messages = document.getElementById('messages');
                var message = document.createElement('div');
                message.className = 'alert alert-danger mt-4';
                message.innerText = 'Erreur lors de l\'achat du domaine.';
                messages.insertBefore(message, messages.firstChild);
                submitButton.disabled = false;
            }
        });
    }

    function configureDNS(domain) {
        $.post('{{ url_for("configure_dns_route") }}', {domain: domain}, function(data) {
            if (data.status === 'configured') {
                // DNS configured, create Nginx config
                createNginxConfig(domain);
            } else if (data.status === 'error') {
                // Error configuring DNS, show error message
                var messages = document.getElementById('messages');
                var message = document.createElement('div');
                message.className = 'alert alert-danger mt-4';
                message.innerText = 'Erreur lors de la configuration du DNS.';
                messages.insertBefore(message, messages.firstChild);
                submitButton.disabled = false;
            }
        });
    }

    function createNginxConfig(domain) {
        $.post('{{ url_for("create_nginx_config_route") }}', {domain: domain}, function(data) {
            if (data.status === 'created') {
                // Nginx config created, set up SSL
                setupSSL(domain);
            } else if (data.status === 'error') {
                // Error creating Nginx config, show error message
                var messages = document.getElementById('messages');
                var message = document.createElement('div');
                message.className = 'alert alert-danger mt-4';
                message.innerText = 'Erreur lors de la création de la configuration Nginx.';
                messages.insertBefore(message, messages.firstChild);
                submitButton.disabled = false;
            }
        });
    }

    function setupSSL(domain) {
        $.post('{{ url_for("setup_ssl_route") }}', {domain: domain}, function(data) {
            if (data.status === 'setup') {
                // SSL set up, install WordPress
                installWordPress(domain);
            } else if (data.status === 'error') {
                // Error setting up SSL, show error message
                var messages = document.getElementById('messages');
                var message = document.createElement('div');
                message.className = 'alert alert-danger mt-4';
                message.innerText = 'Erreur lors de la configuration du SSL.';
                messages.insertBefore(message, messages.firstChild);
                submitButton.disabled = false;
            }
        });
    }

    function installWordPress(domain) {
        $.post('{{ url_for("install_wordpress_route") }}', {domain: domain}, function(data) {
            if (data.status === 'installed') {
                // WordPress installed, show success message
                var messages = document.getElementById('messages');
                var message = document.createElement('div');
                message.className = 'alert alert-success mt-4';
                message.innerText = 'Le domaine ' + domain + ' a été ajouté avec succès.';
                messages.insertBefore(message, messages.firstChild);
                submitButton.disabled = false;
                document.getElementById('domain').value = '';
            } else if (data.status === 'error') {
                // Error installing WordPress, show error message
                var messages = document.getElementById('messages');
                var message = document.createElement('div');
                message.className = 'alert alert-danger mt-4';
                message.innerText = 'Erreur lors de l\'installation de WordPress.';
                messages.insertBefore(message, messages.firstChild);
                submitButton.disabled = false;
            }
        });
    }

    document.getElementById('submitButton').addEventListener('click', function() {
        var messages = document.getElementById('messages');
        messages.innerHTML = '';
    });
</script>
{% endblock %}
