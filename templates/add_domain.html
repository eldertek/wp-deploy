{% extends "base.html" %}

{% block title %}Ajouter un domaine{% endblock %}

{% block content %}
<div class="card shadow-lg p-4 mb-4 w-100">
    <h1 class="card-title">Ajouter un domaine</h1>
    <form id="domainForm">
        <div class="form-group">
            <label for="domain">Nom de domaine</label>
            <input type="text" class="form-control" id="domain" name="domain" required>
        </div>
        <button type="submit" class="btn btn-primary" id="submitButtonInternetBS">Via Internet.bs</button>
        <button type="button" class="btn btn-secondary" id="submitButtonOtherRegistrar">Via un autre registrar</button>
    </form>
</div>
<div id="messages"></div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    console.log('Script loaded');

    var socket = io.connect('https://' + document.domain + ':' + location.port);
    socket.on('message', function (msg) {
        addMessage(msg, 'info');
    });

    socket.on('error', function (msg) {
        addMessage(msg, 'danger');
    });

    socket.on('console', function (msg) {
        console.log('Received console message:', msg);
    });
    
    const stepsInternetBS = [
        { name: 'checkDomainOwnership', func: checkDomainOwnership },
        { name: 'checkDomainAvailability', func: checkDomainAvailability },
        { name: 'purchaseDomain', func: purchaseDomain },
        { name: 'configureDNS', func: configureDNS },
        { name: 'createNginxConfig', func: createNginxConfig },
        { name: 'setupSSL', func: setupSSL },
        { name: 'installWordPress', func: installWordPress },
        { name: 'initializeGitRepo', func: initializeGitRepo },
        { name: 'deployStatic', func: deployStatic }
    ];

    const stepsOtherRegistrar = [
        { name: 'checkDNS', func: checkDNS },
        { name: 'createNginxConfig', func: createNginxConfig },
        { name: 'setupSSL', func: setupSSL },
        { name: 'installWordPress', func: installWordPress },
        { name: 'initializeGitRepo', func: initializeGitRepo },
        { name: 'deployStatic', func: deployStatic }
    ];

    let currentStepIndex = 0;
    let hasErrorOccurred = false;
    let steps = [];
    let tempMessages = [];

    document.getElementById('domainForm').addEventListener('submit', function (event) {
        event.preventDefault();
        $('#messages').empty(); // Clear existing messages
        var domain = $('#domain').val();
        console.log('Form submitted with domain:', domain);
        document.getElementById('submitButtonInternetBS').disabled = true;
        document.getElementById('submitButtonOtherRegistrar').disabled = true;
        currentStepIndex = 0;
        hasErrorOccurred = false;
        tempMessages = [];
        steps = stepsInternetBS;
        executeNextStep(domain);
    });

    document.getElementById('submitButtonOtherRegistrar').addEventListener('click', function () {
        $('#messages').empty(); // Clear existing messages
        var domain = $('#domain').val();
        console.log('Other registrar button clicked with domain:', domain);
        document.getElementById('submitButtonInternetBS').disabled = true;
        document.getElementById('submitButtonOtherRegistrar').disabled = true;
        currentStepIndex = 0;
        hasErrorOccurred = false;
        tempMessages = [];
        steps = stepsOtherRegistrar;
        executeNextStep(domain);
    });

    function executeNextStep(domain) {
        console.log("executeNextStep", currentStepIndex, hasErrorOccurred);
        if (currentStepIndex < steps.length && !hasErrorOccurred) {
            console.log(`Executing step: (${currentStepIndex}) ${steps[currentStepIndex].name}`);
            steps[currentStepIndex].func(domain);
        } else if (!hasErrorOccurred) {
            console.log('All steps completed');
            addMessage(`Le domaine ${domain} a été ajouté avec succès.`, 'success');
            displayTempMessages();
            document.getElementById('submitButtonInternetBS').disabled = false;
            document.getElementById('submitButtonOtherRegistrar').disabled = false;
        }
    }

    function checkDNS(domain) {
        $.post('{{ url_for("deployment.check_dns_route") }}', { domain: domain }, function (data) {
            console.log('DNS check result:', data);
            if (data.status === 'valid') {
                currentStepIndex++;
                displayTempMessages(); // Display messages after each step
                executeNextStep(domain);
            } else {
                handleError(`Le DNS pour le domaine ${domain} n'est pas valide.`, true, domain);
            }
        }).fail(function () {
            handleError('Erreur lors de la vérification du DNS.', true, domain);
        });
    }

    function checkDomainOwnership(domain) {
        $.post('{{ url_for("site_management.check_domain_ownership") }}', { domain: domain }, function (data) {
            console.log('Domain ownership check result:', data);
            if (data.status === 'owned') {
                addMessage(`Le domaine ${domain} vous appartient déjà. Configuration en cours...`, 'info');
                currentStepIndex = steps.findIndex(step => step.name === 'configureDNS');
            } else {
                addMessage(`Le domaine ${domain} n'est pas encore enregistré. Vérification de la disponibilité...`, 'info');
            }
            currentStepIndex++;
            executeNextStep(domain);
        }).fail(function () {
            handleError('Erreur lors de la vérification de la possession du domaine.', true, domain);
        });
    }

    function checkDomainAvailability(domain) {
        $.post('{{ url_for("site_management.check_domain_availability") }}', { domain: domain }, function (data) {
            console.log('Domain availability check result:', data);
            if (data.status === 'available') {
                currentStepIndex++;
                executeNextStep(domain);
            } else {
                handleError(`Le domaine ${domain} n'est pas disponible.`, true, domain);
            }
        }).fail(function () {
            handleError('Erreur lors de la vérification de la disponibilité du domaine.', true, domain);
        });
    }

    function purchaseDomain(domain) {
        $.post('{{ url_for("site_management.purchase_domain_route") }}', { domain: domain }, function (data) {
            console.log('Domain purchase result:', data);
            if (data.status === 'purchased') {
                currentStepIndex++;
                executeNextStep(domain);
            } else {
                handleError(`Erreur lors de l'achat du domaine ${domain}.`, true, domain);
            }
        }).fail(function () {
            handleError(`Erreur lors de l'achat du domaine ${domain}.`, true, domain);
        });
    }

    function configureDNS(domain) {
        $.post('{{ url_for("deployment.configure_dns_route") }}', { domain: domain }, function (data) {
            console.log('DNS configuration result:', data);
            if (data.status === 'configured') {
                currentStepIndex++;
                executeNextStep(domain);
            } else {
                handleError(`Erreur lors de la configuration du DNS pour ${domain}.`, true, domain);
            }
        }).fail(function () {
            handleError(`Erreur lors de la configuration du DNS pour ${domain}.`, true, domain);
        });
    }

    function createNginxConfig(domain) {
        $.post('{{ url_for("deployment.create_nginx_config_route") }}', { domain: domain }, function (data) {
            console.log('Nginx config creation result:', data);
            if (data.status === 'created') {
                currentStepIndex++;
                executeNextStep(domain);
            } else {
                handleError(`Erreur lors de la création de la configuration Nginx pour ${domain}.`);
            }
        }).fail(function () {
            handleError(`Erreur lors de la création de la configuration Nginx pour ${domain}.`);
        });
    }

    function setupSSL(domain) {
        $.post('{{ url_for("deployment.setup_ssl_route") }}', { domain: domain }, function (data) {
            console.log('SSL setup result:', data);
            if (data.status === 'setup') {
                currentStepIndex++;
                executeNextStep(domain);
            } else {
                handleError(`Erreur lors de la configuration du SSL pour ${domain}.`, true, domain);
            }
        }).fail(function () {
            handleError(`Erreur lors de la configuration du SSL pour ${domain}.`, true, domain);
        });
    }

    function installWordPress(domain) {
        $.post('{{ url_for("deployment.install_wordpress_route") }}', { domain: domain }, function (data) {
            console.log('WordPress installation result:', data);
            if (data.status === 'installed') {
                currentStepIndex++;
                executeNextStep(domain);
            } else {
                handleError(`Erreur lors de l'installation de WordPress pour ${domain}.`, true, domain);
            }
        }).fail(function () {
            handleError(`Erreur lors de l'installation de WordPress pour ${domain}.`, true, domain);
        });
    }

    function initializeGitRepo(domain) {
        $.post('{{ url_for("deployment.initialize_git_repo_route") }}', { domain: domain }, function (data) {
            console.log('Git repository initialization result:', data);
            if (data.status === 'initialized') {
                currentStepIndex++;
                executeNextStep(domain);
            } else {
                handleError(`Erreur lors de l'initialisation du dépôt Git pour ${domain}.`, true, domain);
            }
        }).fail(function () {
            handleError(`Erreur lors de l'initialisation du dépôt Git pour ${domain}.`, true, domain);
        });
    }

    function deployStatic(domain) {
        $.post('{{ url_for("deployment.deploy_static_route") }}', { domain: domain }, function (data) {
            console.log('Static deployment result:', data);
            if (data.status === 'deployed') {
                currentStepIndex++;
                executeNextStep(domain);
            } else {
                handleError(`Erreur lors du déploiement statique pour ${domain}.`, true, domain);
            }
        }).fail(function () {
            handleError(`Erreur lors du déploiement statique pour ${domain}.`, true, domain);
        });
    }

    function handleError(errorMessage, restart, domain) {
        if (restart) {
            console.log('Restarting step:', currentStepIndex);
            tempMessages = [];
            steps[currentStepIndex].func(domain);
        } else {
            addMessage(errorMessage, 'danger');
            hasErrorOccurred = true;
            document.getElementById('submitButtonInternetBS').disabled = false;
            document.getElementById('submitButtonOtherRegistrar').disabled = false;
        }
    }

    function addMessage(message, type) {
        tempMessages.push({ message, type });
    }

    function displayTempMessages() {
        var messages = document.getElementById('messages');
        tempMessages.forEach(msg => {
            var messageDiv = document.createElement('div');
            messageDiv.className = `alert alert-${msg.type} mt-4`;
            messageDiv.innerText = msg.message;
            messages.insertBefore(messageDiv, messages.firstChild);
        });
        tempMessages = [];
    }

    document.getElementById('submitButtonInternetBS').addEventListener('click', function () {
        document.getElementById('messages').innerHTML = '';
    });
</script>
{% endblock %}