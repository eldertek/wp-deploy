{% extends "base.html" %}

{% block title %}Ajouter un domaine{% endblock %}

{% block content %}
<div class="card shadow-lg p-4 mb-4 w-100">
    <h1 class="card-title">Ajouter un domaine</h1>
    <form id="domainForm">
        <div class="form-group">
            <label for="domain">Nom de domaine</label>
            <input type="text" class="form-control" id="domain" name="domain" required>
        </div>
        <button type="submit" class="btn btn-primary" id="submitButton">Ajouter</button>
    </form>
</div>
<div id="messages"></div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" role="dialog" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmationModalLabel">Confirmation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="confirmationMessage">
                <!-- Message will be inserted here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirmButton">Continuer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script>
    var socket = io.connect('https://' + document.domain + ':' + location.port);
    socket.on('message', function(msg) {
        var messages = document.getElementById('messages');
        var message = document.createElement('div');
        message.className = 'alert alert-info mt-4';
        message.innerText = msg;
        messages.insertBefore(message, messages.firstChild);
    });

    socket.on('error', function(msg) {
        var messages = document.getElementById('messages');
        var message = document.createElement('div');
        message.className = 'alert alert-danger mt-4';
        message.innerText = msg;
        messages.insertBefore(message, messages.firstChild);
    });

    socket.on('confirm', function(msg) {
        $('#confirmationModal').modal('show');
        $('#confirmationMessage').text(msg);
        $('#confirmButton').data('action', msg.action);
    });

    $('#confirmButton').on('click', function() {
        var action = $(this).data('action');
        var domain = $('#domain').val();
        $.ajax({
            type: 'POST',
            url: '{{ url_for("confirm_action") }}',
            data: {action: action, domain: domain},
            success: function() {
                $('#confirmationModal').modal('hide');
            }
        });
    });

    document.getElementById('domainForm').addEventListener('submit', function(event) {
        event.preventDefault();
        var formData = new FormData(this);
        var submitButton = document.getElementById('submitButton');
        submitButton.disabled = true;
        $.ajax({
            type: 'POST',
            url: '{{ url_for("add_domain") }}',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                submitButton.disabled = false;
                document.getElementById('domain').value = '';
            },
            error: function(error) {
                submitButton.disabled = false;
            }
        });
    });

    document.getElementById('submitButton').addEventListener('click', function() {
        var messages = document.getElementById('messages');
        messages.innerHTML = '';
    });
</script>
{% endblock %}
