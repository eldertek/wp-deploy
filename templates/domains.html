{% extends "base.html" %}

{% block title %}Gestion des domaines{% endblock %}

{% block content %}
<div class="card shadow-lg p-4 mb-4 w-100">
    <h1 class="card-title">Gestion des domaines</h1>
    
    <!-- Formulaire d'ajout de domaine -->
    <form id="domainForm" class="mb-4">
        <div class="form-group">
            <label for="domain">Nom de domaine</label>
            <input type="text" class="form-control" id="domain" name="domain" placeholder="example.com" required>
        </div>
        <button type="submit" class="btn btn-primary" id="submitButtonInternetBS">Achat via Internet.bs</button>
        <button type="button" class="btn btn-secondary" id="submitButtonOtherRegistrar">Autre registrar</button>
    </form>

    <!-- Liste des domaines -->
    <h2>Domaines enregistrés</h2>
    <table class="table" id="domainList">
        <thead>
            <tr>
                <th>Domaine</th>
                <th>Statut</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Les domaines seront ajoutés ici dynamiquement -->
        </tbody>
    </table>
    
    <div id="messages"></div> <!-- Conteneur pour les messages -->
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/jquery.dataTables.min.css">
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.min.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script>
    console.log('Script loaded');

    var socket = io.connect('https://' + document.domain + ':' + location.port + '/domains');
    socket.on('message', function (msg) {
        addMessage(msg, 'info');
    });

    socket.on('error', function (msg) {
        addMessage(msg, 'danger');
    });

    socket.on('console', function (msg) {
        console.log('Received console message:', msg);
    });

    $(document).ready(function() {
        loadDomains(); // Charger les domaines

        // Initialiser DataTable pour la table des domaines
        $('#domainList').DataTable({
            "language": {
                url: '//cdn.datatables.net/plug-ins/2.0.8/i18n/fr-FR.json',
            }
        });

        $('#domainForm').on('submit', function(e) {
            e.preventDefault();
            var domain = $('#domain').val();
            addDomain(domain, 'internetbs');
        });

        $('#submitButtonOtherRegistrar').on('click', function() {
            var domain = $('#domain').val();
            addDomain(domain, 'other');
        });
    });

    function loadDomains() {
        $.get('{{ url_for("domains.get_domains") }}', function(data) {
            $('#domainList').empty();
            data.domains.forEach(function(domain) {
                addDomainToList(domain);
            });
        });
    }

    function addDomain(domain, registrar) {
        $.post('{{ url_for("domains.add_domain") }}', {
            domain: domain,
            registrar: registrar
        }, function(data) {
            if (data.status === 'success') {
                addDomainToList(data.domain);
                $('#domain').val('');
            } else if (data.status === 'error' && data.message === 'Domaine déjà existant') {
                alert('Le domaine est déjà dans la liste.');
            } else {
                alert('Erreur lors de l\'ajout du domaine: ' + data.message);
            }
        });
    }

    function addDomainToList(domain) {
        var row = $('<tr>');
        row.append($('<td>').text(domain.name));
        row.append($('<td>').text(domain.status));
        var actionsCell = $('<td>');
        
        if (domain.status !== 'Configuré') {
            actionsCell.append($('<button>').addClass('btn btn-sm btn-primary mr-2').text('Configurer').click(function() {
                configureDomain(domain.name);
            }));
        }
        
        // Ajout du bouton de suppression avec une marge
        actionsCell.append($('<button>').addClass('btn btn-sm btn-danger').text('Supprimer').click(function() {
            deleteDomain(domain.name);
        }));
        
        row.append(actionsCell);
        $('#domainList').append(row);
    }

    function configureDomain(domain) {
        $.post('{{ url_for("domains.configure_domain") }}', {
            domain: domain
        }, function(data) {
            if (data.status === 'success') {
                loadDomains();
            } else {
                alert('Erreur lors de la configuration du domaine: ' + data.message);
            }
        });
    }

    function deleteDomain(domainName) {
        if (confirm('Êtes-vous sûr de vouloir supprimer ce domaine ?')) {
            $.post('{{ url_for("domains.delete_domain") }}', { domain: domainName }, function(data) {
                if (data.status === 'success') {
                    loadDomains(); // Recharge la liste des domaines
                } else {
                    alert('Erreur lors de la suppression du domaine: ' + data.message);
                }
            });
        }
    }

    function addMessage(msg, type) {
        var messageContainer = $('#messages'); // Assurez-vous d'avoir un conteneur pour les messages
        var alertClass = type === 'info' ? 'alert alert-info' : 'alert alert-danger';
        var message = $('<div>').addClass(alertClass).text(msg);
        messageContainer.append(message);
        setTimeout(function() {
            message.fadeOut(); // Optionnel : faire disparaître le message après un certain temps
        }, 3000);
    }
</script>
{% endblock %}