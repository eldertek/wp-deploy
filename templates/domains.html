{% extends "base.html" %}

{% block title %}Gestion des domaines{% endblock %}

{% block content %}
<div class="card shadow-lg p-4 mb-4 w-100">
    <h1 class="card-title">Gestion des domaines</h1>
    
    <!-- Formulaire d'ajout de domaine -->
    <form id="domainForm" class="mb-4">
        <div class="form-group">
            <label for="domain">Nom de domaine</label>
            <input type="text" class="form-control" id="domain" name="domain" placeholder="example.com" required>
        </div>
        <button type="submit" class="btn btn-primary" id="submitButtonInternetBS">Achat via Internet.bs</button>
        <button type="button" class="btn btn-secondary" id="submitButtonOtherRegistrar">Autre registrar</button>
    </form>

    <!-- Liste des domaines -->
    <h2>Domaines enregistrés</h2>
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="thead-dark">
                <tr>
                    <th>Domaine</th>
                    <th>Statut</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="domainList">
                <!-- Les domaines seront ajoutés ici dynamiquement -->
            </tbody>
        </table>
    </div>
    <div id="socket-messages"></div> <!-- Added container for socket messages -->
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    console.log('Script loaded');

    $(document).ready(function() {
        loadDomains();

        $('#domainForm').on('submit', function(e) {
            e.preventDefault();
            var domain = $('#domain').val();
            addDomain(domain, 'internetbs');
        });

        $('#submitButtonOtherRegistrar').on('click', function() {
            var domain = $('#domain').val();
            addDomain(domain, 'other');
        });
    });

    function loadDomains() {
        $.get('{{ url_for("domains.get_domains") }}', function(data) {
            var groupedDomains = groupDomainsByStatus(data.domains);
            $('#domainList').empty();
            
            // Définir l'ordre des statuts
            var statusOrder = [
                'En attente de vérification',
                'En attente de configuration',
                'Configuré'
            ];
            
            // Ajouter les groupes dans l'ordre spécifié
            statusOrder.forEach(function(status) {
                if (groupedDomains[status]) {
                    addStatusGroup(status, groupedDomains[status]);
                }
            });
            
            // Ajouter les autres statuts non spécifiés, s'il y en a
            Object.keys(groupedDomains).forEach(function(status) {
                if (!statusOrder.includes(status)) {
                    addStatusGroup(status, groupedDomains[status]);
                }
            });
        });
    }

    function groupDomainsByStatus(domains) {
        return domains.reduce(function(acc, domain) {
            (acc[domain.status] = acc[domain.status] || []).push(domain);
            return acc;
        }, {});
    }

    function addStatusGroup(status, domains) {
        var statusRow = $('<tr>').addClass('table-secondary');
        statusRow.append($('<td colspan="3">').text(status).addClass('font-weight-bold'));
        $('#domainList').append(statusRow);
        
        domains.forEach(function(domain) {
            addDomainToList(domain);
        });
    }

    function addDomainToList(domain) {
        var row = $('<tr>');
        row.append($('<td>').text(domain.name));
        row.append($('<td>').text(domain.status));
        var actionsCell = $('<td>');
        
        if (domain.status === 'En attente de vérification') {
            actionsCell.append($('<button>').addClass('btn btn-sm btn-warning mr-2').text('Vérifier').click(function() {
                configureDomain(domain.name);
            }));
        } else if (domain.status !== 'Configuré') {
            actionsCell.append($('<button>').addClass('btn btn-sm btn-primary mr-2').text('Configurer').click(function() {
                configureDomain(domain.name);
            }));
        }
        
        actionsCell.append($('<button>').addClass('btn btn-sm btn-danger').text('Supprimer').click(function() {
            deleteDomain(domain.name);
        }));
        
        row.append(actionsCell);
        $('#domainList').append(row);
    }

    function configureDomain(domain) {
        $.post('{{ url_for("domains.configure_domain") }}', {
            domain: domain
        }, function(data) {
            if (data.status === 'success') {
                loadDomains();
            } else {
                alert('Erreur lors de la configuration du domaine: ' + data.message);
            }
        });
    }

    function deleteDomain(domainName) {
        if (confirm('Êtes-vous sûr de vouloir supprimer ce domaine ?')) {
            $.post('{{ url_for("domains.delete_domain") }}', { domain: domainName }, function(data) {
                if (data.status === 'success') {
                    loadDomains(); // Recharge la liste des domaines
                } else {
                    alert('Erreur lors de la suppression du domaine: ' + data.message);
                }
            });
        }
    }

    function addDomain(domain, registrar) {
        $.post('{{ url_for("domains.add_domain") }}', {
            domain: domain,
            registrar: registrar
        }, function(data) {
            if (data.status === 'success') {
                $('#domain').val(''); // Clear the input field
                loadDomains(); // Reload the domain list
                addMessage('Domaine ajouté avec succès', 'info');
            } else {
                addMessage("Erreur lors de l'ajout du domaine: " + data.message, 'danger');
            }
        }).fail(function() {
            addMessage('Erreur de communication avec le serveur', 'danger');
        });
    }

    function addMessage(msg, type) {
        var messageContainer = $('#socket-messages');
        var alertClass = type === 'info' ? 'alert-info' : 'alert-danger';
        var message = $('<div>').addClass('alert ' + alertClass + ' alert-dismissible fade show').text(msg);
        message.append('<button type="button" class="close" data-dismiss="alert">&times;</button>');
        
        messageContainer.append(message);
        setTimeout(function() {
            message.remove();
        }, 5000);
    }
</script>
{% endblock %}