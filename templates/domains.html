{% extends "base.html" %}

{% block title %}Gestion des domaines{% endblock %}

{% block content %}
<div class="card shadow-lg p-4 mb-4 w-100">
    <h1 class="card-title">Gestion des domaines</h1>
    
    <!-- Formulaire d'ajout de domaine -->
    <form id="domainForm" class="mb-4">
        <div class="form-group">
            <label for="domain">Nom de domaine</label>
            <input type="text" class="form-control" id="domain" name="domain" placeholder="example.com" required>
        </div>
        <button type="submit" class="btn btn-primary" id="submitButtonInternetBS">Achat via Internet.bs</button>
        <button type="button" class="btn btn-secondary" id="submitButtonOtherRegistrar">Autre registrar</button>
    </form>

    <!-- Liste des domaines -->
    <h2>Domaines enregistrés</h2>
    <table class="table">
        <thead>
            <tr>
                <th>Domaine</th>
                <th>Statut</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="domainList">
            <!-- Les domaines seront ajoutés ici dynamiquement -->
        </tbody>
    </table>
    <div id="socket-messages"></div> <!-- Added container for socket messages -->
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    console.log('Script loaded');

    $(document).ready(function() {
        loadDomains();

        $('#domainForm').on('submit', function(e) {
            e.preventDefault();
            var domain = $('#domain').val();
            addDomain(domain, 'internetbs');
        });

        $('#submitButtonOtherRegistrar').on('click', function() {
            var domain = $('#domain').val();
            addDomain(domain, 'other');
        });
    });

    function loadDomains() {
        $.get('{{ url_for("domains.get_domains") }}', function(data) {
            addDomainToList(data.domains);
        });
    }

    function addDomain(domain, registrar) {
        $.post('{{ url_for("domains.add_domain") }}', {
            domain: domain,
            registrar: registrar
        }, function(data) {
            if (data.status === 'success') {
                addDomainToList(data.domain);
                $('#domain').val('');
            } else if (data.status === 'error' && data.message === 'Domaine déjà existant') {
                alert('Le domaine est déjà dans la liste.');
            } else {
                alert('Erreur lors de l\'ajout du domaine: ' + data.message);
            }
        });
    }

    function addDomainToList(domains) {
        // Clear existing rows
        $('#domainList').empty();

        // Group domains by status
        const groupedDomains = {};
        domains.forEach(domain => {
            if (!groupedDomains[domain.status]) {
                groupedDomains[domain.status] = [];
            }
            groupedDomains[domain.status].push(domain);
        });

        // Create rows for each status group
        for (const status in groupedDomains) {
            // Add a header row for the status with Bootstrap styling
            $('#domainList').append($('<tr>').append($('<td colspan="3" class="table-primary font-weight-bold text-center">').text(status)));

            // Add each domain under the status
            groupedDomains[status].forEach(domain => {
                var row = $('<tr>');
                row.append($('<td>').text(domain.name));
                row.append($('<td>').text(domain.status));
                var actionsCell = $('<td>');

                if (domain.status === 'En attente de vérification') {
                    actionsCell.append($('<button>').addClass('btn btn-sm btn-warning mr-2').text('Vérifier').click(function() {
                        configureDomain(domain.name);
                    }));
                } else if (domain.status !== 'Configuré') {
                    actionsCell.append($('<button>').addClass('btn btn-sm btn-primary mr-2').text('Configurer').click(function() {
                        configureDomain(domain.name);
                    }));
                }

                actionsCell.append($('<button>').addClass('btn btn-sm btn-danger').text('Supprimer').click(function() {
                    deleteDomain(domain.name);
                }));

                row.append(actionsCell);
                $('#domainList').append(row);
            });
        }
    }

    function configureDomain(domain) {
        $.post('{{ url_for("domains.configure_domain") }}', {
            domain: domain
        }, function(data) {
            if (data.status === 'success') {
                loadDomains();
            } else {
                alert('Erreur lors de la configuration du domaine: ' + data.message);
            }
        });
    }

    function deleteDomain(domainName) {
        if (confirm('Êtes-vous sûr de vouloir supprimer ce domaine ?')) {
            $.post('{{ url_for("domains.delete_domain") }}', { domain: domainName }, function(data) {
                if (data.status === 'success') {
                    loadDomains(); // Recharge la liste des domaines
                } else {
                    alert('Erreur lors de la suppression du domaine: ' + data.message);
                }
            });
        }
    }

    function addMessage(msg, type) {
        var messageContainer = $('#messages'); // Assurez-vous d'avoir un conteneur pour les messages
        var alertClass = type === 'info' ? 'alert alert-info' : 'alert alert-danger';
        var message = $('<div>').addClass(alertClass).text(msg);
        
        // Check if messageContainer exists before appending
        if (messageContainer.length) {
            messageContainer.append(message);
            setTimeout(function() {
                message.fadeOut(); // Optionnel : faire disparaître le message après un certain temps
            }, 3000);
        }
    }
</script>
{% endblock %}